// ==========================================
// ãƒ›ãƒ¼ã‚¹æ ¼ç´åº«è©³ç´°ãƒ»ç‚¹æ¤œãƒšãƒ¼ã‚¸ï¼ˆå®Œå…¨æ›¸ãç›´ã—ç‰ˆï¼‰
// ==========================================
app.get('/storage/:id', async (c) => {
  const id = c.req.param('id')
  
  return c.html(`
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¼ç´åº«è©³ç´° - æ´»å‹•è¨˜éŒ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .float-animation { animation: float 3s ease-in-out infinite; }
        input, textarea, select {
            font-size: 16px !important;
        }
        button {
            -webkit-tap-highlight-color: transparent;
            min-height: 48px;
        }
        .modal-open {
            display: flex !important;
        }
        .modal-closed {
            display: none !important;
        }
    </style>
</head>
<body>
    <nav class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center space-x-3">
                    <span class="text-4xl float-animation">ğŸ”¥</span>
                    <div class="text-gray-800">
                        <div class="font-bold text-xl">æ´»å‹•è¨˜éŒ²</div>
                        <div class="text-sm text-gray-600">å¤§äº•ç”ºæ¶ˆé˜²å›£ç¬¬ä¸€åˆ†å›£</div>
                    </div>
                </a>
                <a href="/inspection-priority" class="text-blue-600 hover:text-blue-800 hover:underline text-sm bg-blue-50 px-4 py-2 rounded-lg font-bold">
                    â† å„ªå…ˆåº¦ä¸€è¦§
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div id="storageDetail" class="mb-6">
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center"><p class="text-gray-800">èª­ã¿è¾¼ã¿ä¸­...</p></div>
        </div>

        <!-- ç‚¹æ¤œè¨˜éŒ²ãƒœã‚¿ãƒ³ -->
        <button id="showModalBtn" class="w-full bg-red-500 hover:bg-red-600 text-white px-6 py-4 rounded-xl transition font-bold text-lg mb-6">
            ğŸ“ ç‚¹æ¤œã‚’è¨˜éŒ²ã™ã‚‹
        </button>

        <!-- ç‚¹æ¤œå±¥æ­´ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“‹ ç‚¹æ¤œå±¥æ­´</h2>
            <div id="inspectionHistory">
                <p class="text-gray-600 text-center py-4">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <!-- å¯¾å¿œå±¥æ­´ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸš¨ å¯¾å¿œå±¥æ­´</h2>
            <div id="actionHistory">
                <p class="text-gray-600 text-center py-4">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- ç‚¹æ¤œè¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="inspectionModal" class="modal-closed fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 my-8" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ“ ç‚¹æ¤œã‚’è¨˜éŒ²</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ‘¤ å…¥åŠ›è€… <span class="text-red-500">*</span></label>
                    <select id="inspectorName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“… ç‚¹æ¤œæ—¥ <span class="text-red-500">*</span></label>
                    <input type="date" id="inspectionDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">âœ… çµæœ <span class="text-red-500">*</span></label>
                    <select id="inspectionResult" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="normal">æ­£å¸¸</option>
                        <option value="caution">è¦æ³¨æ„</option>
                        <option value="abnormal">ç•°å¸¸ã‚ã‚Š</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸš¨ è¦å¯¾å¿œäº‹é …ï¼ˆã‚ã‚Œã°ï¼‰</label>
                    <textarea id="actionRequired" rows="4" placeholder="å¯¾å¿œãŒå¿…è¦ãªå†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“ å‚™è€ƒ</label>
                    <textarea id="remarks" rows="3" placeholder="ãã®ä»–ãƒ¡ãƒ¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></textarea>
                </div>

                <!-- ç ´æçŠ¶æ³ã®å†™çœŸ -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“· ç ´æçŠ¶æ³ã®å†™çœŸï¼ˆä»»æ„ï¼‰</label>
                    <input type="file" id="inspectionImage" accept="image/*" multiple class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <p class="text-sm text-gray-600 mt-1">
                        ğŸ’¡ ç ´æç®‡æ‰€ã‚„æ°—ã«ãªã‚‹ç‚¹ã®å†™çœŸã‚’è¤‡æ•°æšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                    </p>
                    <div id="inspectionImagePreview" style="display:none;" class="mt-4 space-y-2">
                        <div id="previewImages" class="grid grid-cols-2 gap-2"></div>
                        <button type="button" id="clearImagesBtn" class="text-red-500 hover:text-red-700 text-sm">
                            ğŸ—‘ï¸ ã™ã¹ã¦ã®ç”»åƒã‚’å‰Šé™¤
                        </button>
                    </div>
                </div>

                <div class="flex flex-col space-y-3 pt-4">
                    <button type="button" id="saveBtn" class="w-full bg-red-500 hover:bg-red-600 text-white px-6 py-4 rounded-xl transition font-bold text-lg">
                        âœ… ä¿å­˜ã™ã‚‹
                    </button>
                    <button type="button" id="cancelBtn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-4 rounded-xl transition font-bold text-lg">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å®šæ•°
        const STORAGE_ID = '${id}';
        let storageData = null;

        // DOMè¦ç´ ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼‰
        let modal, showModalBtn, closeModalBtn, cancelBtn, saveBtn, imageInput, clearImagesBtn;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal() {
            modal.classList.remove('modal-closed');
            modal.classList.add('modal-open');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideModal() {
            modal.classList.remove('modal-open');
            modal.classList.add('modal-closed');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // DOMè¦ç´ ã®å–å¾—ï¼ˆã“ã“ã§DOMæº–å‚™å®Œäº†ã—ã¦ã‚‹ã‹ã‚‰ç¢ºå®Ÿã«å–ã‚Œã‚‹ï¼‰
            modal = document.getElementById('inspectionModal');
            showModalBtn = document.getElementById('showModalBtn');
            closeModalBtn = document.getElementById('closeModalBtn');
            cancelBtn = document.getElementById('cancelBtn');
            saveBtn = document.getElementById('saveBtn');
            imageInput = document.getElementById('inspectionImage');
            clearImagesBtn = document.getElementById('clearImagesBtn');

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆè¦ç´ ãŒç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹çŠ¶æ…‹ã§è¨­å®šï¼‰
            showModalBtn.addEventListener('click', showModal);
            closeModalBtn.addEventListener('click', hideModal);
            cancelBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', hideModal);
            saveBtn.addEventListener('click', saveInspection);
            imageInput.addEventListener('change', previewInspectionImages);
            clearImagesBtn.addEventListener('click', clearInspectionImages);

            // åˆæœŸå€¤è¨­å®šã¨èª­ã¿è¾¼ã¿
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspectionDate').value = today;
            
            loadMembers();
            loadStorageDetail();
            loadInspectionHistory();
            loadActionHistory();
        });

        // å›£å“¡ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadMembers() {
            try {
                const response = await fetch('/api/members');
                const data = await response.json();
                const select = document.getElementById('inspectorName');
                
                data.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load members:', error);
            }
        }

        // æ ¼ç´åº«è©³ç´°èª­ã¿è¾¼ã¿
        async function loadStorageDetail() {
            try {
                const response = await fetch('/api/hose/storages');
                const data = await response.json();
                storageData = data.storages.find(s => s.id === STORAGE_ID);
                
                if (storageData) {
                    document.getElementById('storageDetail').innerHTML = 
                        '<div class="bg-white rounded-2xl shadow-lg p-6">' +
                            '<h1 class="text-3xl font-bold text-gray-800 mb-4">ğŸ“¦ ' + storageData.storage_number + '</h1>' +
                            (storageData.image_url ? 
                                '<div class="mb-4">' +
                                    '<img src="' + storageData.image_url + '" alt="æ ¼ç´åº«å†™çœŸ" class="w-full h-64 object-cover rounded-lg">' +
                                '</div>' : ''
                            ) +
                            '<p class="text-xl text-gray-700 mb-2">ğŸ“ ' + storageData.location + '</p>' +
                            (storageData.district ? '<p class="text-base text-gray-600 mb-2">ğŸ˜ï¸ ' + storageData.district + '</p>' : '') +
                            (storageData.remarks ? '<p class="text-base text-gray-600 mb-2">ğŸ’¬ ' + storageData.remarks + '</p>' : '') +
                            (storageData.address ? '<p class="text-base text-gray-600">ğŸ  ' + storageData.address + '</p>' : '') +
                        '</div>';
                }
            } catch (error) {
                console.error(error);
            }
        }

        // ç‚¹æ¤œå±¥æ­´èª­ã¿è¾¼ã¿
        async function loadInspectionHistory() {
            try {
                const response = await fetch('/api/inspection/history/' + STORAGE_ID);
                const data = await response.json();
                renderHistory(data.inspections || []);
            } catch (error) {
                document.getElementById('inspectionHistory').innerHTML = 
                    '<p class="text-gray-600 text-center py-4">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        // ç‚¹æ¤œå±¥æ­´è¡¨ç¤º
        function renderHistory(inspections) {
            const container = document.getElementById('inspectionHistory');
            
            if (inspections.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-4">ã¾ã ç‚¹æ¤œè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = inspections.map(insp => {
                const date = new Date(insp.inspection_date).toLocaleDateString('ja-JP');
                const resultText = {normal: 'æ­£å¸¸', caution: 'è¦æ³¨æ„', abnormal: 'ç•°å¸¸ã‚ã‚Š'}[insp.result] || insp.result;
                const resultColor = {normal: 'bg-green-500', caution: 'bg-yellow-500', abnormal: 'bg-red-500'}[insp.result] || 'bg-gray-500';
                
                // å†™çœŸãŒã‚ã‚‹å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
                let photosHtml = '';
                if (insp.photos) {
                    try {
                        const photos = JSON.parse(insp.photos);
                        if (photos.length > 0) {
                            photosHtml = '<div class="mt-3"><p class="text-gray-700 text-sm font-semibold mb-2">ğŸ“· ç ´æçŠ¶æ³ã®å†™çœŸ:</p>' +
                                '<div class="grid grid-cols-2 gap-2">' +
                                photos.map(url => '<img src="' + url + '" alt="ç‚¹æ¤œå†™çœŸ" class="w-full h-32 object-cover rounded-lg cursor-pointer" onclick="window.open(&quot;' + url + '&quot;, &quot;_blank&quot;)">').join('') +
                                '</div></div>';
                        }
                    } catch (e) {
                        console.error('Failed to parse photos:', e);
                    }
                }
                
                return '<div class="bg-gray-50 border-l-4 ' + (resultColor.replace('bg-', 'border-')) + ' rounded-lg p-4 mb-3">' +
                    '<div class="flex justify-between items-start mb-2">' +
                        '<span class="text-gray-800 font-bold">' + date + '</span>' +
                        '<span class="' + resultColor + ' text-white px-3 py-1 rounded-full text-sm font-bold">' + resultText + '</span>' +
                    '</div>' +
                    (insp.inspector_name ? '<p class="text-gray-700 mb-2">ğŸ‘¤ å…¥åŠ›è€…: ' + insp.inspector_name + '</p>' : '') +
                    (insp.action_required ? '<p class="text-gray-700 mb-2">ğŸš¨ è¦å¯¾å¿œ: ' + insp.action_required + '</p>' : '') +
                    (insp.remarks ? '<p class="text-gray-600 text-sm mb-2">ğŸ’¬ ' + insp.remarks + '</p>' : '') +
                    photosHtml +
                '</div>';
            }).join('');
        }

        // å¯¾å¿œå±¥æ­´èª­ã¿è¾¼ã¿
        async function loadActionHistory() {
            try {
                const response = await fetch('/api/inspection/action-history/' + STORAGE_ID);
                const data = await response.json();
                renderActionHistory(data.actions || []);
            } catch (error) {
                document.getElementById('actionHistory').innerHTML = 
                    '<p class="text-gray-600 text-center py-4">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        // å¯¾å¿œå±¥æ­´è¡¨ç¤º
        function renderActionHistory(actions) {
            const container = document.getElementById('actionHistory');
            
            if (actions.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-4">å¯¾å¿œå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = actions.map(action => {
                const inspectionDate = new Date(action.inspection_date).toLocaleDateString('ja-JP');
                const completedDate = new Date(action.action_completed_at).toLocaleDateString('ja-JP');
                
                // å†™çœŸãŒã‚ã‚‹å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
                let photosHtml = '';
                if (action.photos) {
                    try {
                        const photos = JSON.parse(action.photos);
                        if (photos.length > 0) {
                            photosHtml = '<div class="mt-3"><p class="text-gray-700 text-sm font-semibold mb-2">ğŸ“· ç ´æçŠ¶æ³ã®å†™çœŸ:</p>' +
                                '<div class="grid grid-cols-2 gap-2">' +
                                photos.map(url => '<img src="' + url + '" alt="ç‚¹æ¤œå†™çœŸ" class="w-full h-32 object-cover rounded-lg cursor-pointer" onclick="window.open(&quot;' + url + '&quot;, &quot;_blank&quot;)">').join('') +
                                '</div></div>';
                        }
                    } catch (e) {
                        console.error('Failed to parse photos:', e);
                    }
                }
                
                return '<div class="bg-gray-50 rounded-lg p-4 mb-3 border border-gray-200">' +
                    '<div class="flex justify-between items-start mb-3">' +
                        '<span class="text-gray-800 font-bold">ç‚¹æ¤œæ—¥: ' + inspectionDate + '</span>' +
                        '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">âœ… å®Œäº†</span>' +
                    '</div>' +
                    '<div class="bg-red-50 border-l-4 border-red-500 rounded p-3 mb-2">' +
                        '<p class="text-red-800 text-sm font-semibold mb-1">ğŸš¨ è¦å¯¾å¿œå†…å®¹:</p>' +
                        '<p class="text-gray-700 text-sm">' + action.action_required + '</p>' +
                    '</div>' +
                    '<div class="bg-green-50 border-l-4 border-green-500 rounded p-3 mb-2">' +
                        '<p class="text-green-800 text-sm font-semibold mb-1">âœ… å¯¾å¿œå†…å®¹:</p>' +
                        '<p class="text-gray-700 text-sm">' + (action.action_content || 'è¨˜è¼‰ãªã—') + '</p>' +
                    '</div>' +
                    photosHtml +
                    '<p class="text-gray-500 text-xs text-right mt-2">å¯¾å¿œå®Œäº†æ—¥: ' + completedDate + '</p>' +
                '</div>';
            }).join('');
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewInspectionImages(event) {
            const files = event.target.files;
            if (files.length > 0) {
                const container = document.getElementById('previewImages');
                container.innerHTML = '';
                
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.innerHTML = '<img src="' + e.target.result + '" alt="Preview ' + (index + 1) + '" class="w-full h-32 object-cover rounded-lg">';
                        container.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
                
                document.getElementById('inspectionImagePreview').style.display = 'block';
            }
        }

        // ç”»åƒã‚¯ãƒªã‚¢
        function clearInspectionImages() {
            document.getElementById('inspectionImage').value = '';
            document.getElementById('inspectionImagePreview').style.display = 'none';
            document.getElementById('previewImages').innerHTML = '';
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadInspectionImages() {
            const fileInput = document.getElementById('inspectionImage');
            if (!fileInput.files || fileInput.files.length === 0) {
                return [];
            }

            const imageUrls = [];
            for (const file of fileInput.files) {
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        imageUrls.push(result.imageUrl);
                    }
                } catch (error) {
                    console.error('Image upload error:', error);
                }
            }
            
            return imageUrls;
        }

        // ç‚¹æ¤œè¨˜éŒ²ä¿å­˜
        async function saveInspection() {
            const inspectorName = document.getElementById('inspectorName').value;
            const date = document.getElementById('inspectionDate').value;
            const result = document.getElementById('inspectionResult').value;
            const actionRequired = document.getElementById('actionRequired').value;
            const remarks = document.getElementById('remarks').value;

            if (!inspectorName || !date || !result) {
                alert('å…¥åŠ›è€…ã€ç‚¹æ¤œæ—¥ã€çµæœã¯å¿…é ˆã§ã™');
                return;
            }

            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            const imageUrls = await uploadInspectionImages();

            const data = {
                storage_id: STORAGE_ID,
                storage_number: storageData.storage_number,
                inspection_date: date,
                result: result,
                action_required: actionRequired || null,
                remarks: remarks || null,
                inspector_name: inspectorName,
                photos: imageUrls.length > 0 ? JSON.stringify(imageUrls) : null
            };

            try {
                const response = await fetch('/api/inspection/record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('ç‚¹æ¤œè¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    hideModal();
                    loadInspectionHistory();
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('inspectorName').value = '';
                    document.getElementById('inspectionResult').value = '';
                    document.getElementById('actionRequired').value = '';
                    document.getElementById('remarks').value = '';
                    clearInspectionImages();
                } else {
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }
    </script>
</body>
</html>
  `)
})
